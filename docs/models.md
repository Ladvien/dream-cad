# MVDream Model Management

## Overview

MVDream uses pre-trained diffusion models to generate multi-view consistent images that can be converted to 3D models. This document describes model management, storage, and usage.

## Model Storage

All models are stored on the data drive to avoid disk space issues:

- **Cache Directory**: `/mnt/datadrive_m2/.huggingface/`
- **Model Directory**: `/mnt/datadrive_m2/dream-cad/models/`
- **Environment Variables**:
  - `HF_HOME=/mnt/datadrive_m2/.huggingface`
  - `HUGGINGFACE_HUB_CACHE=/mnt/datadrive_m2/.huggingface/hub`

## Available Models

### sd-v2.1-base-4view.pt

- **Source**: MVDream/MVDream repository on Hugging Face
- **Size**: ~10GB
- **Purpose**: Base model for 4-view generation
- **Architecture**: Stable Diffusion 2.1 modified for multi-view consistency
- **Input**: Text prompts
- **Output**: 4 consistent views (front, back, left, right) at 256x256 resolution

## Model Download

### Using Poetry Task

```bash
# Download all required models
poe download-models

# This will:
# 1. Check available disk space
# 2. Download models from Hugging Face
# 3. Calculate and verify checksums
# 4. Save model information to models/model_info.json
```

### Manual Download

```bash
# Run the download script directly
cd /mnt/datadrive_m2/dream-cad
poetry run python scripts/download_models.py
```

### Verify Models

```bash
# Verify model integrity
poe verify-models

# Test model loading
poetry run python scripts/test_model_loading.py
```

## Disk Space Management

### Requirements

- **Minimum**: 15GB free space for model download
- **Recommended**: 25GB free space for models + generation outputs
- **Location**: Always use `/mnt/datadrive_m2` for storage

### Current Usage

After model download, disk usage will be approximately:

```
/mnt/datadrive_m2/
├── .huggingface/       # ~10GB (model cache)
├── dream-cad/
│   ├── models/         # ~10GB (local copies)
│   └── outputs/        # Variable (generated content)
```

Total: ~20GB for models (cache + local)

### Monitoring Disk Space

```bash
# Check disk space
df -h /mnt/datadrive_m2

# Check model sizes
du -sh /mnt/datadrive_m2/.huggingface
du -sh /mnt/datadrive_m2/dream-cad/models
```

## Model Information File

The `models/model_info.json` file contains:

```json
{
  "sd-v2.1-base-4view.pt": {
    "path": "/mnt/datadrive_m2/dream-cad/models/sd-v2.1-base-4view.pt",
    "sha256": "<64-character-hash>",
    "size_bytes": 10737418240
  }
}
```

This file is automatically generated during download and used for verification.

## Backup Strategy

### Local Backup

Models are stored in two locations:
1. Hugging Face cache: `/mnt/datadrive_m2/.huggingface/`
2. Local models directory: `/mnt/datadrive_m2/dream-cad/models/`

### External Backup (Optional)

For external drive backup:

```bash
# Mount external drive
sudo mount /dev/sdX1 /mnt/backup

# Backup models
rsync -av /mnt/datadrive_m2/dream-cad/models/ /mnt/backup/mvdream-models/

# Verify backup
ls -lh /mnt/backup/mvdream-models/
```

## Troubleshooting

### Insufficient Disk Space

If download fails due to disk space:

1. Check current usage:
   ```bash
   df -h /mnt/datadrive_m2
   du -sh /mnt/datadrive_m2/* | sort -h
   ```

2. Clean unnecessary files:
   ```bash
   # Clean pip cache
   poetry run pip cache purge
   
   # Clean old outputs
   rm -rf /mnt/datadrive_m2/dream-cad/outputs/old_*
   ```

3. Use symlinks for models (if needed):
   ```bash
   # Link models from external drive
   ln -s /mnt/external/mvdream-models /mnt/datadrive_m2/dream-cad/models
   ```

### Model Loading Errors

If models fail to load:

1. Verify file integrity:
   ```bash
   poe verify-models
   ```

2. Check PyTorch CUDA:
   ```bash
   poetry run python -c "import torch; print(torch.cuda.is_available())"
   ```

3. Test with CPU loading:
   ```bash
   poetry run python scripts/test_model_loading.py --device cpu
   ```

### Download Interruptions

If download is interrupted:

1. Delete partial files:
   ```bash
   rm -f /mnt/datadrive_m2/.huggingface/hub/*.part
   ```

2. Re-run download:
   ```bash
   poe download-models
   ```

The download will resume from where it left off.

## Model Usage in Code

### Loading Models

```python
import torch
from pathlib import Path

# Load model
model_path = Path("/mnt/datadrive_m2/dream-cad/models/sd-v2.1-base-4view.pt")
checkpoint = torch.load(model_path, map_location="cuda")

# Access model weights
if "state_dict" in checkpoint:
    state_dict = checkpoint["state_dict"]
elif "model" in checkpoint:
    state_dict = checkpoint["model"]
else:
    state_dict = checkpoint
```

### Integration with MVDream

The models are automatically loaded by MVDream when running generation:

```python
from mvdream.model_zoo import build_model

# MVDream will automatically find models in the configured paths
model = build_model("sd-v2.1-base-4view")
```

## Performance Notes

- **GPU Memory**: Models require ~10GB VRAM when loaded
- **Loading Time**: Initial load takes 10-30 seconds
- **Generation Memory**: Full generation requires ~20GB VRAM
- **CPU Fallback**: Models can run on CPU but 10-50x slower

## Updates and Versioning

Check for model updates:

```bash
# Check Hugging Face for updates
poetry run python -c "from huggingface_hub import model_info; print(model_info('MVDream/MVDream'))"
```

New model versions will be documented here with migration instructions.